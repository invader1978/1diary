<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</title>

<style>
:root{
  --bg:#000;
  --card:#1c1c1e;
  --line:rgba(255,255,255,.08);
  --text:#fff;
  --accent:#ff375f;
  --danger:#ff3b30;
  --radius:24px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  display:flex;
  justify-content:center;
  color:var(--text);
}
.phone{
  width:390px;
  min-height:100vh;
  padding:14px;
}

/* ===== Top ===== */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.top-left,.top-right{
  display:flex;
  gap:10px;
}
.iconbtn,.editbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.08);
  color:var(--accent);
  padding:8px 14px;
  font-weight:600;
}
.title{font-weight:800;}

/* ===== Card ===== */
.card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
}

/* ===== Swipe ===== */
.swipe-wrap{
  position:relative;
  overflow:hidden;
}
.actions{
  position:absolute;
  top:0;right:0;bottom:0;
  display:flex;
}
.actions button{
  width:90px;
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:700;
}

/* ===== Row ===== */
.row{
  display:flex;
  align-items:center;
  gap:12px;
  padding:16px;
  border-bottom:1px solid var(--line);
  background:var(--card);
  transition:transform .18s ease;
}
.row:last-child{border-bottom:none;}

.dragging{opacity:.4;}

.del{
  display:none;
  width:26px;height:26px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  border:none;
}
.edit .del{display:flex;justify-content:center;align-items:center;}

.cb{width:22px;height:22px;}
.edit .cb{opacity:.3;pointer-events:none;}

.text{flex:1;font-size:18px;}
.checked{text-decoration:line-through;opacity:.5;}

.handle{
  display:none;
  font-size:20px;
  cursor:grab;
}
.edit .handle{display:block;}

/* ===== Add ===== */
.bottom{margin-top:14px;}
.plus{
  width:56px;height:56px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.08);
  font-size:26px;
  color:#fff;
}
.inputwrap{display:none;margin-top:10px;}
.inputwrap.show{display:block;}
.input{
  width:100%;height:50px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:0 14px;
}
</style>
</head>

<body>
<div class="phone" id="app">

  <div class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="trashBtn">üóë</button>
      <button class="editbtn" id="editBtn">Á∑®ÈõÜ</button>
    </div>
    <div class="title">„É™„Çπ„Éà</div>
    <div class="top-right">
      <button class="iconbtn" id="shareBtn">ÂÖ±Êúâ</button>
    </div>
  </div>

  <div class="card" id="list"></div>

  <div class="bottom">
    <button class="plus" id="plusBtn">Ôºã</button>
    <div class="inputwrap" id="inputWrap">
      <input class="input" id="newText" placeholder="Ë≤∑„ÅÜ„ÇÇ„ÅÆ„ÇíÂÖ•Âäõ‚Ä¶" />
    </div>
  </div>

</div>

<script>
const KEY="shopping_list_stable_v2";
let items=[];
let editMode=false;
let openId=null;
let dragEl=null;

load();
render();

/* ===== Header ===== */
editBtn.onclick=()=>{
  editMode=!editMode;
  app.classList.toggle("edit",editMode);
  editBtn.textContent=editMode?"‚úì":"Á∑®ÈõÜ";
  openId=null;
  render();
};

trashBtn.onclick=()=>{
  if(confirm("ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){
    items=[];save();render();
  }
};

/* ===== Share ===== */
shareBtn.onclick=async()=>{
  const text=items.map(i=>`${i.done?"‚òë":"‚òê"} ${i.text}`).join("\n");
  try{
    if(navigator.share){
      await navigator.share({title:"Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà",text});
    }else{
      await navigator.clipboard.writeText(text);
      alert("„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
    }
  }catch(e){}
};

/* ===== Add ===== */
plusBtn.onclick=()=>{
  if(!inputWrap.classList.contains("show")){
    inputWrap.classList.add("show");
    newText.focus();
  }else commitAdd();
};
newText.onkeydown=e=>{
  if(e.key==="Enter")commitAdd();
};
function commitAdd(){
  const text=newText.value.trim();
  if(!text)return;
  items.push({id:crypto.randomUUID(),text,done:false});
  newText.value="";
  save();render();
}

/* ===== Data ===== */
function toggle(id,val){
  if(editMode)return;
  const it=items.find(i=>i.id===id);
  if(it){it.done=val;save();render();}
}
function removeOne(id){
  items=items.filter(i=>i.id!==id);
  save();render();
}
function save(){localStorage.setItem(KEY,JSON.stringify(items));}
function load(){
  const raw=localStorage.getItem(KEY);
  items=raw?JSON.parse(raw):[];
}

/* ===== Render ===== */
function render(){
  list.innerHTML="";
  items.forEach(it=>{
    const wrap=document.createElement("div");
    wrap.className="swipe-wrap";
    wrap.dataset.id=it.id;

    const actions=document.createElement("div");
    actions.className="actions";
    const delBtn=document.createElement("button");
    delBtn.textContent="ÂâäÈô§";
    delBtn.onclick=()=>removeOne(it.id);
    actions.appendChild(delBtn);

    const row=document.createElement("div");
    row.className="row";

    row.style.transform=(!editMode&&openId===it.id)?"translateX(-90px)":"translateX(0)";

    const del=document.createElement("button");
    del.className="del";
    del.textContent="‚àí";
    del.onclick=()=>removeOne(it.id);
    row.appendChild(del);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.className="cb";
    cb.checked=it.done;
    cb.onchange=()=>toggle(it.id,cb.checked);
    row.appendChild(cb);

    const text=document.createElement("div");
    text.className="text"+(it.done?" checked":"");
    text.textContent=it.text;
    row.appendChild(text);

    const handle=document.createElement("div");
    handle.className="handle";
    handle.textContent="‚â°";
    handle.onpointerdown=e=>startDrag(e,wrap);
    row.appendChild(handle);

    attachSwipe(row,it.id);

    wrap.appendChild(actions);
    wrap.appendChild(row);
    list.appendChild(wrap);
  });
}

/* ===== Swipe ===== */
function attachSwipe(row,id){
  let startX=0,startY=0,swiping=false,currentX=0;
  const isInteractive=t=>!!t.closest("input,button,.handle");

  row.onpointerdown=e=>{
    if(editMode||isInteractive(e.target))return;
    startX=e.clientX;
    startY=e.clientY;
    swiping=false;
    row.style.transition="none";
  };

  row.onpointermove=e=>{
    if(editMode||startX===0)return;
    const dx=e.clientX-startX;
    const dy=e.clientY-startY;

    if(!swiping){
      if(Math.abs(dx)<12)return;
      if(Math.abs(dx)<=Math.abs(dy))return;
      swiping=true;
    }
    currentX=Math.min(0,Math.max(-90,dx));
    row.style.transform=`translateX(${currentX}px)`;
  };

  row.onpointerup=()=>{
    if(editMode)return;
    if(!swiping){startX=0;return;}
    row.style.transition="transform .18s ease";
    openId=(currentX<=-45)?id:null;
    startX=0;
    render();
  };
}

/* ===== Drag Reorder ===== */
function startDrag(e,wrap){
  if(!editMode)return;
  dragEl=wrap;
  wrap.querySelector(".row").classList.add("dragging");

  const move=ev=>{
    const after=getAfter(ev.clientY);
    if(after==null)list.appendChild(dragEl);
    else list.insertBefore(dragEl,after);
  };
  const up=()=>{
    dragEl.querySelector(".row").classList.remove("dragging");
    dragEl=null;
    persist();
    window.removeEventListener("pointermove",move);
    window.removeEventListener("pointerup",up);
  };
  window.addEventListener("pointermove",move);
  window.addEventListener("pointerup",up);
}
function getAfter(y){
  const els=[...list.querySelectorAll(".swipe-wrap")].filter(w=>w!==dragEl);
  let closest={offset:-Infinity,el:null};
  els.forEach(w=>{
    const box=w.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0&&offset>closest.offset){
      closest={offset,el:w};
    }
  });
  return closest.el;
}
function persist(){
  const ordered=[...list.querySelectorAll(".swipe-wrap")].map(w=>w.dataset.id);
  const map=new Map(items.map(i=>[i.id,i]));
  items=ordered.map(id=>map.get(id));
  save();
}
</script>
</body>
</html>
