<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</title>

<style>
:root{
  --bg:#000;
  --card:#1c1c1e;
  --line:rgba(255,255,255,.08);
  --text:#fff;
  --sub:rgba(255,255,255,.6);
  --accent:#ff375f;
  --danger:#ff3b30;
  --radius:24px;
}

*{box-sizing:border-box;}
html,body{height:100%; -webkit-text-size-adjust:100%;}
body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  display:flex;
  justify-content:center;
  color:var(--text);
  -webkit-user-select:none;
  user-select:none;
  touch-action:manipulation;
}
button, .row{ -webkit-user-select:none; user-select:none; }
input{ -webkit-user-select:text; user-select:text; }

.phone{ width:390px; min-height:100vh; padding:14px; }

/* =======================
   Top BarÔºà„Çø„Ç§„Éà„É´ÂÆåÂÖ®Âõ∫ÂÆöÔºâ
======================= */
.topbar{
  position:relative;
  height:64px;
  margin-bottom:14px;
}
.top-left,
.top-right{
  position:absolute;
  top:0;
  height:100%;
  display:flex;
  align-items:center;
  gap:12px;
  width:150px;          /* Âõ∫ÂÆöÂπÖÔºà„Ç∫„É¨Èò≤Ê≠¢Ôºâ */
}
.top-left{ left:0; }
.top-right{ right:0; justify-content:flex-end; }

.title{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-weight:900;
  font-size:20px;
  pointer-events:none;
}

.iconbtn, .editbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:var(--accent);
  padding:12px 18px;
  font-weight:900;
  font-size:18px;
  min-height:52px;
}

/* =======================
   Card
======================= */
.card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
}

.swipe-wrap{ position:relative; overflow:hidden; }

.actions{
  position:absolute;
  top:0; right:0; bottom:0;
  display:flex;
}
.actions button{
  width:98px;
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:900;
}
.edit .actions{ display:none !important; }

/* =======================
   Row
======================= */
.row{
  display:flex;
  align-items:center;
  padding:18px 16px;
  border-bottom:1px solid var(--line);
  background:var(--card);
  transition:transform .18s ease;
  -webkit-touch-callout:none;
}
.row:last-child{border-bottom:none;}
.dragging{opacity:.35;}

.leftSlot{ width:34px; flex:0 0 34px; display:flex; }
.rightSlot{ width:40px; flex:0 0 40px; display:flex; justify-content:flex-end; }

.del{
  width:30px;height:30px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  border:none;
  font-size:18px;
  opacity:0;
  transform:translateX(-12px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
}
.edit .del{
  opacity:1;
  transform:translateX(0);
  pointer-events:auto;
}

.cb{
  width:26px;height:26px;
  margin-right:12px;
}
.edit .cb{
  opacity:.25;
  pointer-events:none;
}

.text{
  flex:1;
  font-size:18px;
}
.checked{ text-decoration:line-through; opacity:.5; }

.handle{
  font-size:22px;
  color:var(--sub);
  opacity:0;
  transform:translateX(12px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  touch-action:none;
}
.edit .handle{
  opacity:1;
  transform:translateX(0);
  pointer-events:auto;
}

/* =======================
   Add
======================= */
.bottom{ margin-top:14px; }
.plus{
  width:60px;height:60px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  font-size:30px;
  color:#fff;
}
.inputwrap{ display:none; margin-top:10px; }
.inputwrap.show{ display:block; }
.input{
  width:100%;
  height:56px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:#fff;
  padding:0 14px;
}
</style>
</head>

<body>
<div class="phone" id="app">

  <div class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="trashBtn">üóë</button>
      <button class="editbtn" id="editBtn">Á∑®ÈõÜ</button>
    </div>

    <div class="title">„É™„Çπ„Éà</div>

    <div class="top-right">
      <button class="iconbtn" id="shareBtn">ÂÖ±Êúâ</button>
    </div>
  </div>

  <div class="card" id="list"></div>

  <div class="bottom">
    <button class="plus" id="plusBtn">Ôºã</button>
    <div class="inputwrap" id="inputWrap">
      <input class="input" id="newText" placeholder="Ë≤∑„ÅÜ„ÇÇ„ÅÆ„ÇíÂÖ•Âäõ‚Ä¶" />
    </div>
  </div>

</div>

<script>
document.addEventListener("contextmenu", e=>e.preventDefault(),{passive:false});
document.addEventListener("gesturestart", e=>e.preventDefault(),{passive:false});
document.addEventListener("gesturechange", e=>e.preventDefault(),{passive:false});
document.addEventListener("gestureend", e=>e.preventDefault(),{passive:false});

const KEY="shopping_list_ios_final_v2";
let items=[];
let editMode=false;
let openId=null;
let dragWrap=null;

load(); render();

editBtn.onclick=()=>{
  openId=null;
  editMode=!editMode;
  app.classList.toggle("edit",editMode);
  editBtn.textContent=editMode?"‚úì":"Á∑®ÈõÜ";
  render();
};

trashBtn.onclick=()=>{
  if(confirm("ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){
    items=[]; save(); render();
  }
};

shareBtn.onclick=async()=>{
  const text=items.map(i=>`${i.done?"‚òë":"‚òê"} ${i.text}`).join("\n");
  try{
    if(navigator.share){
      await navigator.share({title:"Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà",text});
    }else{
      await navigator.clipboard.writeText(text);
      alert("„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
    }
  }catch{}
};

plusBtn.onclick=()=>{
  if(!inputWrap.classList.contains("show")){
    inputWrap.classList.add("show");
    newText.focus();
  }else commitAdd();
};
newText.onkeydown=e=>{
  if(e.key==="Enter") commitAdd();
  if(e.key==="Escape"){ inputWrap.classList.remove("show"); newText.value=""; }
};

function commitAdd(){
  const t=newText.value.trim();
  if(!t)return;
  items.push({id:crypto.randomUUID(),text:t,done:false});
  newText.value="";
  save(); render();
  newText.focus();
}

function toggleDone(id,val){
  if(editMode)return;
  const it=items.find(x=>x.id===id);
  if(it){ it.done=val; save(); render(); }
}

function removeOne(id){
  items=items.filter(x=>x.id!==id);
  save(); render();
}

function save(){localStorage.setItem(KEY,JSON.stringify(items));}
function load(){
  const raw=localStorage.getItem(KEY);
  items=raw?JSON.parse(raw):[];
}

function render(){
  list.innerHTML="";
  items.forEach(it=>{
    const wrap=document.createElement("div");
    wrap.className="swipe-wrap";
    wrap.dataset.id=it.id;

    if(!editMode){
      const actions=document.createElement("div");
      actions.className="actions";
      const b=document.createElement("button");
      b.textContent="ÂâäÈô§";
      b.onclick=()=>removeOne(it.id);
      actions.appendChild(b);
      wrap.appendChild(actions);
    }

    const row=document.createElement("div");
    row.className="row";
    row.style.transform=editMode?"translateX(0)":
      (openId===it.id?"translateX(-98px)":"translateX(0)");

    const left=document.createElement("div");
    left.className="leftSlot";
    const minus=document.createElement("button");
    minus.className="del";
    minus.textContent="‚àí";
    minus.onclick=()=>removeOne(it.id);
    left.appendChild(minus);
    row.appendChild(left);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.className="cb";
    cb.checked=it.done;
    cb.disabled=editMode;
    cb.onchange=()=>toggleDone(it.id,cb.checked);
    row.appendChild(cb);

    const text=document.createElement("div");
    text.className="text"+(it.done?" checked":"");
    text.textContent=it.text;
    row.appendChild(text);

    const right=document.createElement("div");
    right.className="rightSlot";
    const handle=document.createElement("div");
    handle.className="handle";
    handle.textContent="‚â°";
    handle.onpointerdown=e=>{
      if(!editMode) return;
      e.preventDefault();
      e.stopPropagation();
      startDrag(e,wrap);
    };
    right.appendChild(handle);
    row.appendChild(right);

    if(!editMode) attachSwipe(row,it.id);

    wrap.appendChild(row);
    list.appendChild(wrap);
  });
}

/* ‚úÖ „Åì„Åì„Åå‰øÆÊ≠£ÁÇπÔºö„ÉÅ„Çß„ÉÉ„ÇØ/„Éú„Çø„É≥/ÂÖ•Âäõ„Å´Ëß¶„Çå„Åü„Çâ„Çπ„ÉØ„Ç§„Éó„ÇíÈñãÂßã„Åó„Å™„ÅÑ */
function attachSwipe(row,id){
  let startX=0,startY=0,swiping=false,currentX=0;

  const isInteractive = (t) => !!t.closest("input,button,.handle,.del");

  row.onpointerdown=(e)=>{
    if(editMode) return;

    // ‚úÖ „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÁ≠â„ÇíËß¶„Å£„ÅüÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„Åì„Çå„Åß„ÉÅ„Çß„ÉÉ„ÇØ„ÅåÁ¢∫ÂÆü„Å´ÂÖ•„ÇãÔºâ
    if(isInteractive(e.target)) return;

    // Êó¢„Å´Âà•„ÅÆË°å„ÅåÈñã„ÅÑ„Å¶„Åü„ÇâÈñâ„Åò„Çã
    if(openId && openId !== id){
      openId = null;
      render();
    }

    startX=e.clientX;
    startY=e.clientY;
    swiping=false;
    currentX=(openId===id)?-98:0;
    row.style.transition="none";
  };

  row.onpointermove=(e)=>{
    if(editMode || startX===0) return;

    const dx=e.clientX-startX;
    const dy=e.clientY-startY;

    if(!swiping){
      if(Math.abs(dx)<12) return;
      if(Math.abs(dx)<=Math.abs(dy)) return;
      swiping=true;
    }

    let x=currentX+dx;
    x=Math.min(0,Math.max(-98,x));
    row.style.transform=`translateX(${x}px)`;
  };

  row.onpointerup=()=>{
    if(editMode) return;
    if(!swiping){ startX=0; return; }

    // ÁèæÂú®‰ΩçÁΩÆ„ÇíË¶ã„Å¶Á¢∫ÂÆö
    const tr=getComputedStyle(row).transform;
    let x=0;
    if(tr && tr!=="none"){
      const m=tr.match(/matrix\(([^)]+)\)/);
      if(m){
        const parts=m[1].split(",").map(v=>parseFloat(v));
        x=parts[4]||0;
      }
    }

    row.style.transition="transform .18s ease";
    openId=(x<=-49)?id:null;
    startX=0;
    render();
  };

  row.onpointercancel=row.onpointerup;
}

/* Drag */
function startDrag(e,wrap){
  dragWrap=wrap;
  const row=wrap.querySelector(".row");
  row.classList.add("dragging");

  const move=ev=>{
    const after=getAfter(ev.clientY);
    if(after==null) list.appendChild(dragWrap);
    else list.insertBefore(dragWrap,after);
  };
  const up=()=>{
    row.classList.remove("dragging");
    dragWrap=null;
    persist();
    window.removeEventListener("pointermove",move);
    window.removeEventListener("pointerup",up);
    window.removeEventListener("pointercancel",up);
  };

  window.addEventListener("pointermove",move,{passive:false});
  window.addEventListener("pointerup",up,{passive:false});
  window.addEventListener("pointercancel",up,{passive:false});
}

function getAfter(y){
  const els=[...list.querySelectorAll(".swipe-wrap")].filter(w=>w!==dragWrap);
  let closest={offset:-Infinity,el:null};
  els.forEach(w=>{
    const box=w.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0&&offset>closest.offset) closest={offset,el:w};
  });
  return closest.el;
}

function persist(){
  const ordered=[...list.querySelectorAll(".swipe-wrap")].map(w=>w.dataset.id);
  const map=new Map(items.map(i=>[i.id,i]));
  items=ordered.map(id=>map.get(id)).filter(Boolean);
  save();
}
</script>
</body>
</html>
