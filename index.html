<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</title>

<style>
:root{
  --bg:#000;
  --card:#1c1c1e;
  --line:rgba(255,255,255,.08);
  --text:#fff;
  --sub:rgba(255,255,255,.6);
  --accent:#ff375f;
  --danger:#ff3b30;
  --radius:24px;

  --actionW: 98px;
  --spring: cubic-bezier(.2,.95,.2,1.1);
}

*{box-sizing:border-box;}
html,body{height:100%; -webkit-text-size-adjust:100%;}

body{
  margin:0;
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  display:flex;
  justify-content:center;
  color:var(--text);
  -webkit-user-select:none;
  user-select:none;
  touch-action:manipulation;
  overscroll-behavior:none;
}

button, .row{ -webkit-user-select:none; user-select:none; }
input{ -webkit-user-select:text; user-select:text; }

.phone{
  width:390px;
  min-height:100vh;
  padding:14px;
  display:flex;
  flex-direction:column;
}

/* =======================
   Top Bar
======================= */
.topbar{
  position:relative;
  height:64px;
  margin-bottom:14px;
  flex:0 0 auto;
}
.top-left,
.top-right{
  position:absolute;
  top:0;
  height:100%;
  display:flex;
  align-items:center;
  gap:12px;
  width:150px;
}
.top-left{ left:0; }
.top-right{ right:0; justify-content:flex-end; }

.title{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-weight:900;
  font-size:20px;
  pointer-events:none;
}

.iconbtn, .editbtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:var(--accent);
  padding:12px 18px;
  font-weight:900;
  font-size:18px;
  min-height:52px;
  transition:transform .12s ease, filter .12s ease;
}
.iconbtn:active, .editbtn:active{
  transform:scale(.97);
  filter:brightness(1.08);
}

/* =======================
   Card
======================= */
.card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  flex:0 0 auto;
}

.swipe-wrap{ position:relative; overflow:hidden; width:100%; }

.row{ width:100%; position:relative; z-index:2; }
.actions{ z-index:1; }

.actions{
  position:absolute;
  top:0; right:0; bottom:0;
  display:flex;
}
.actions button{
  width:var(--actionW);
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:900;
  border-top-left-radius:14px;
  border-bottom-left-radius:14px;
  transition:transform .12s ease, filter .12s ease;
}
.actions button:active{
  transform:scale(.98);
  filter:brightness(1.06);
}

/* Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÅØ„Çπ„ÉØ„Ç§„ÉóÂâäÈô§„ÇíÁÑ°ÂäπÂåñÔºà‚àí„ÅßÈñã„ÅèÔºâ */
.edit .actions{
  opacity:0;
  pointer-events:none;
}
.edit .swipe-wrap.show-actions .actions{
  opacity:1;
  pointer-events:auto;
}

/* =======================
   Row
======================= */
.row{
  display:flex;
  align-items:center;
  padding:18px 16px;
  border-bottom:1px solid var(--line);
  background:var(--card);
  transition:transform .22s var(--spring), filter .12s ease;
  -webkit-touch-callout:none;

  touch-action: pan-y;
}
.row:active{ filter:brightness(1.06); }
.row:last-child{border-bottom:none;}
.dragging{opacity:.35;}

.leftSlot{ width:34px; flex:0 0 34px; display:flex; }
.rightSlot{ width:40px; flex:0 0 40px; display:flex; justify-content:flex-end; }

.del{
  width:30px;height:30px;
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  border:none;
  opacity:0;
  transform:translateX(-12px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease, filter .12s ease;
  display:flex;
  align-items:center;
  justify-content:center;
}
.del:active{ filter:brightness(1.08); transform:translateX(0) scale(.97); }

.edit .del{
  opacity:1;
  transform:translateX(0);
  pointer-events:auto;
}

.cb{
  width:26px;height:26px;
  margin-right:12px;
}
.edit .cb{
  opacity:.25;
  pointer-events:none;
}

.text{
  flex:1;
  font-size:18px;
}
.checked{ text-decoration:line-through; opacity:.5; }

.handle{
  font-size:22px;
  color:var(--sub);
  opacity:0;
  transform:translateX(12px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  touch-action:none;
}
.edit .handle{
  opacity:1;
  transform:translateX(0);
  pointer-events:auto;
}

/* =======================
   Spacer
======================= */
.spacer{
  flex:1 1 auto;
  max-height:80px;
}

/* =======================
   Add
======================= */
.bottom{
  flex:0 0 auto;
}
.plus{
  width:60px;height:60px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  font-size:30px;
  color:#fff;
  transition:transform .12s ease, filter .12s ease;
}
.plus:active{
  transform:scale(.97);
  filter:brightness(1.08);
}
.inputwrap{ display:none; margin-top:10px; }
.inputwrap.show{ display:block; }
.input{
  width:100%;
  height:56px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.10);
  color:#fff;
  padding:0 14px;
}

.del .minus-bar{
  display:block;
  width:14px;
  height:3px;
  background:#fff;
  border-radius:999px;
}

/* =======================
   Placeholder
======================= */
.placeholder{
  background:rgba(255,255,255,.06);
  border-top:1px dashed rgba(255,255,255,.18);
  border-bottom:1px dashed rgba(255,255,255,.18);
}

/* =======================
   Modal (A11yÂº∑Âåñ)
   ‚Äª ÂÄãÂà•ÂâäÈô§„Åß„ÅØ‰Ωø„Çè„Åö„ÄÅ„ÄåÂÖ®ÂâäÈô§„Äç„Å†„Åë„ÅßÂà©Áî®
======================= */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.45);
  z-index:9999;
  padding:18px;
}
.modal.show{ display:flex; }

.modal-card{
  width:min(340px, 100%);
  background:rgba(28,28,30,.92);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  overflow:hidden;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
}

.modal-body{
  padding:18px 16px 14px;
  text-align:center;
}
.modal-title{
  font-weight:900;
  font-size:16px;
  margin:0 0 8px;
}
.modal-msg{
  color:rgba(255,255,255,.72);
  font-size:13px;
  margin:0;
  line-height:1.45;
}

.modal-actions{
  display:flex;
  border-top:1px solid rgba(255,255,255,.10);
}
.modal-actions button{
  flex:1;
  height:48px;
  border:none;
  background:transparent;
  color:#fff;
  font-weight:900;
  font-size:15px;
  transition:filter .12s ease, transform .12s ease;
}
.modal-actions button:active{ filter:brightness(1.10); transform:scale(.99); }
.modal-actions button + button{
  border-left:1px solid rgba(255,255,255,.10);
}
.modal-actions .danger{ color: var(--danger); }

/* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ‚ÄúÊµÆ„ÅÑ„Å¶„ÇãË°å‚Äù */
.floating{
  position:fixed !important;
  left:0;
  top:0;
  z-index:9998;
  pointer-events:none;
  transform: translate3d(0,0,0);
  will-change: transform;
  filter: brightness(1.05);
  box-shadow: 0 18px 50px rgba(0,0,0,.55);
  border-radius: 16px;
  overflow:hidden;
}

/* A11y: „Çπ„ÇØ„É™„Éº„É≥„É™„Éº„ÉÄ„ÉºÁî® */
.sr-only{
  position:absolute !important;
  width:1px;height:1px;
  padding:0;margin:-1px;
  overflow:hidden;clip:rect(0,0,0,0);
  white-space:nowrap;border:0;
}
</style>
</head>

<body>
<div class="phone" id="app">

  <div class="topbar">
    <div class="top-left">
      <button class="iconbtn" id="trashBtn" aria-label="ÂÖ®ÂâäÈô§">üóë</button>
      <button class="editbtn" id="editBtn" aria-label="Á∑®ÈõÜ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà">Á∑®ÈõÜ</button>
    </div>

    <div class="title">„É™„Çπ„Éà</div>

    <div class="top-right">
      <button class="iconbtn" id="shareBtn" aria-label="ÂÖ±Êúâ">ÂÖ±Êúâ</button>
    </div>
  </div>

  <div class="card" id="list" role="list" aria-label="Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà"></div>

  <div class="spacer" aria-hidden="true"></div>

  <div class="bottom">
    <button class="plus" id="plusBtn" aria-label="È†ÖÁõÆ„ÇíËøΩÂä†">Ôºã</button>
    <div class="inputwrap" id="inputWrap">
      <input class="input" id="newText" placeholder="Ë≤∑„ÅÜ„ÇÇ„ÅÆ„ÇíÂÖ•Âäõ‚Ä¶" aria-label="ËøΩÂä†„Åô„ÇãÈ†ÖÁõÆ" />
    </div>
  </div>

</div>

<!-- ‚úÖ A11y: Áä∂ÊÖãÈÄöÁü•Ôºàaria-liveÔºâ -->
<div class="sr-only" id="live" aria-live="polite" aria-atomic="true"></div>

<!-- ‚úÖ confirm„É¢„Éº„ÉÄ„É´ÔºàÂÖ®ÂâäÈô§„ÅÆ„ÅøÔºâ -->
<div class="modal" id="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMsg">
  <div class="modal-card" role="document">
    <div class="modal-body">
      <h3 class="modal-title" id="modalTitle">Á¢∫Ë™ç</h3>
      <p class="modal-msg" id="modalMsg">„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü</p>
    </div>
    <div class="modal-actions">
      <button type="button" id="modalCancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button type="button" class="danger" id="modalOk">ÂâäÈô§</button>
    </div>
  </div>
</div>

<script>
/* =======================
   Touch-only protections
======================= */
const IS_TOUCH = matchMedia("(pointer: coarse)").matches || "ontouchstart" in window;
if(IS_TOUCH){
  document.addEventListener("contextmenu", e=>e.preventDefault(),{passive:false});
  document.addEventListener("gesturestart", e=>e.preventDefault(),{passive:false});
  document.addEventListener("gesturechange", e=>e.preventDefault(),{passive:false});
  document.addEventListener("gestureend", e=>e.preventDefault(),{passive:false});
}

/* =======================
   DOM
======================= */
const dom = {
  app: document.getElementById("app"),
  list: document.getElementById("list"),
  editBtn: document.getElementById("editBtn"),
  trashBtn: document.getElementById("trashBtn"),
  shareBtn: document.getElementById("shareBtn"),
  plusBtn: document.getElementById("plusBtn"),
  inputWrap: document.getElementById("inputWrap"),
  newText: document.getElementById("newText"),
  topbar: document.querySelector(".topbar"),
  bottom: document.querySelector(".bottom"),
  live: document.getElementById("live"),

  modal: document.getElementById("modal"),
  modalTitle: document.getElementById("modalTitle"),
  modalMsg: document.getElementById("modalMsg"),
  modalCancel: document.getElementById("modalCancel"),
  modalOk: document.getElementById("modalOk"),
};

const state = {
  items: [],
  editMode: false,
  openId: null,
  openEditId: null,

  dragWrap: null,
  placeholder: null,
  dragOffsetY: 0,
  dragPointerId: null,
  rafId: null,
  latestClientY: 0,

  modalResolver: null,
  modalPrevFocus: null,
};

const ACTION_W = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--actionW"), 10) || 98;

/* =======================
   Utils
======================= */
function announce(msg){
  dom.live.textContent = "";
  setTimeout(()=>{ dom.live.textContent = msg; }, 10);
}
function uid(){
  try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch{}
  return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2);
}
function wrapEl(id){ return dom.list.querySelector(`.swipe-wrap[data-id="${CSS.escape(id)}"]`); }
function rowEl(id){ const w=wrapEl(id); return w ? w.querySelector(".row") : null; }
function getItem(id){ return state.items.find(x=>x.id===id) || null; }

/* =======================
   Layout
======================= */
function layoutCardHeight(){
  const s = getComputedStyle(dom.app);
  const padTop = parseFloat(s.paddingTop) || 0;
  const padBottom = parseFloat(s.paddingBottom) || 0;

  const reserve = 80;
  const available = window.innerHeight - dom.topbar.offsetHeight - dom.bottom.offsetHeight - padTop - padBottom - reserve;
  const maxH = Math.max(180, available - 14);
  dom.list.style.maxHeight = maxH + "px";
}
window.addEventListener("resize", layoutCardHeight);
window.addEventListener("orientationchange", layoutCardHeight);

/* =======================
   Storage
======================= */
const STORAGE = (() => {
  const KEY = "shopping_list_ios_v9b";
  const OLD_KEYS = ["shopping_list_ios_v9", "shopping_list_ios_v8", "shopping_list_ios_final_v8"];

  function save(){
    try{ localStorage.setItem(KEY, JSON.stringify(state.items)); }catch{}
  }

  function _loadFromKey(k){
    const raw = localStorage.getItem(k);
    if(!raw) return null;
    try{
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed)) return null;
      return parsed
        .map(x=>({
          id: (x && typeof x.id==="string" && x.id) ? x.id : uid(),
          text: String(x?.text ?? "").trim(),
          done: !!x?.done
        }))
        .filter(x=>x.text);
    }catch{
      return null;
    }
  }

  function load(){
    let loaded = _loadFromKey(KEY);

    if(!loaded){
      for(const k of OLD_KEYS){
        const old = _loadFromKey(k);
        if(old){
          loaded = old;
          state.items = loaded;
          save();
          try{ localStorage.removeItem(k); }catch{}
          announce("„Éá„Éº„Çø„ÇíÊñ∞ÂΩ¢Âºè„Å´ÁßªË°å„Åó„Åæ„Åó„Åü");
          return;
        }
      }
    }

    if(loaded){
      state.items = loaded;
    }else{
      state.items = [];
      try{ localStorage.removeItem(KEY); }catch{}
    }
  }

  return { load, save };
})();

/* =======================
   ModalÔºàÂÖ®ÂâäÈô§„ÅÆ„ÅøÔºâ
======================= */
const MODAL = (() => {
  function _focusables(){
    return [...dom.modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')]
      .filter(el => !el.disabled && el.offsetParent !== null);
  }

  function showConfirm({title="Á¢∫Ë™ç", message="„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü", okText="OK", cancelText="„Ç≠„É£„É≥„Çª„É´", danger=false}){
    state.modalPrevFocus = document.activeElement;

    dom.modalTitle.textContent = title;
    dom.modalMsg.textContent = message;
    dom.modalOk.textContent = okText;
    dom.modalCancel.textContent = cancelText;
    dom.modalOk.classList.toggle("danger", !!danger);

    dom.modal.classList.add("show");
    dom.modal.setAttribute("aria-hidden","false");
    setTimeout(()=>{ dom.modalCancel.focus?.(); }, 0);

    return new Promise(resolve => { state.modalResolver = resolve; });
  }

  function hideConfirm(val){
    dom.modal.classList.remove("show");
    dom.modal.setAttribute("aria-hidden","true");

    const r = state.modalResolver;
    state.modalResolver = null;

    try{ state.modalPrevFocus?.focus?.(); }catch{}
    state.modalPrevFocus = null;

    if(r) r(!!val);
  }

  dom.modalCancel.addEventListener("click", ()=>hideConfirm(false));
  dom.modalOk.addEventListener("click", ()=>hideConfirm(true));
  dom.modal.addEventListener("click", (e)=>{ if(e.target === dom.modal) hideConfirm(false); });

  document.addEventListener("keydown",(e)=>{
    if(!dom.modal.classList.contains("show")) return;

    if(e.key==="Escape"){
      e.preventDefault();
      hideConfirm(false);
      return;
    }

    if(e.key==="Tab"){
      const f = _focusables();
      if(!f.length) return;

      const first = f[0];
      const last = f[f.length-1];
      const active = document.activeElement;

      if(e.shiftKey){
        if(active === first || !dom.modal.contains(active)){
          e.preventDefault();
          last.focus();
        }
      }else{
        if(active === last){
          e.preventDefault();
          first.focus();
        }
      }
    }
  });

  return { showConfirm };
})();

/* =======================
   Swipe helpers
======================= */
function setRowX(id, x){
  const row = rowEl(id);
  if(!row) return;
  row._x = x;
  row.style.transform = `translateX(${x}px)`;
}

function closeAllSwipe(){
  if(state.openId){
    setRowX(state.openId, 0);
    state.openId = null;
  }
  if(state.openEditId){
    const w = wrapEl(state.openEditId);
    if(w) w.classList.remove("show-actions");
    setRowX(state.openEditId, 0);
    state.openEditId = null;
  }
}
function closeOpenIfDifferent(id){
  if(state.openId && state.openId !== id){
    setRowX(state.openId, 0);
    state.openId = null;
  }
}

/* =======================
   ‚úÖ ÂÄãÂà•ÂâäÈô§ÔºöÁ¢∫Ë™ç„Å™„ÅóÔºàÂç≥ÂâäÈô§Ôºâ
======================= */
function removeOne(id){
  const it = getItem(id);
  if(!it) return;

  // Èñã„ÅçÁä∂ÊÖã„ÇíÈñâ„Åò„Çã
  if(state.openId === id){ setRowX(id, 0); state.openId = null; }
  if(state.openEditId === id){
    const w = wrapEl(id);
    if(w) w.classList.remove("show-actions");
    setRowX(id, 0);
    state.openEditId = null;
  }

  // state
  state.items = state.items.filter(x=>x.id!==id);
  STORAGE.save();

  // DOM
  const w = wrapEl(id);
  if(w) w.remove();

  layoutCardHeight();
  announce(`ÂâäÈô§„Åó„Åæ„Åó„Åü: ${it.text}`);
}

/* =======================
   State ops
======================= */
function toggleDone(id,val){
  if(state.editMode) return;
  const it = getItem(id);
  if(!it) return;

  it.done = !!val;
  STORAGE.save();

  const w = wrapEl(id);
  if(!w) return;

  const text = w.querySelector(".text");
  text.classList.toggle("checked", it.done);

  const cb = w.querySelector(".cb");
  if(cb) cb.checked = it.done;

  announce(`${it.text} „Çí ${it.done ? "ÂÆå‰∫Ü" : "Êú™ÂÆå‰∫Ü"} „Å´„Åó„Åæ„Åó„Åü`);
}

/* =======================
   DOMÂ∑ÆÂàÜ swapÔºàAlt+‚Üë/‚ÜìÔºâ
======================= */
function swapItemsAndDomById(idA, idB){
  const iA = state.items.findIndex(x=>x.id===idA);
  const iB = state.items.findIndex(x=>x.id===idB);
  if(iA < 0 || iB < 0) return false;

  const tmp = state.items[iA];
  state.items[iA] = state.items[iB];
  state.items[iB] = tmp;
  STORAGE.save();

  const elA = wrapEl(idA);
  const elB = wrapEl(idB);
  if(!elA || !elB) return false;

  const parent = dom.list;
  const nextA = elA.nextSibling;
  const nextB = elB.nextSibling;

  parent.insertBefore(elA, nextB);
  parent.insertBefore(elB, nextA);

  return true;
}

function moveItemById(id, dir){
  const idx = state.items.findIndex(x=>x.id===id);
  if(idx < 0) return false;
  const next = idx + dir;
  if(next < 0 || next >= state.items.length) return false;

  const idA = state.items[idx].id;
  const idB = state.items[next].id;
  const ok = swapItemsAndDomById(idA, idB);
  if(ok) layoutCardHeight();
  return ok;
}

/* =======================
   Render
======================= */
function renderAll(){
  dom.list.innerHTML="";
  state.items.forEach(it => dom.list.appendChild(buildRow(it)));
}

/* =======================
   Build row
======================= */
function buildRow(it){
  const wrap=document.createElement("div");
  wrap.className="swipe-wrap";
  wrap.dataset.id=it.id;
  wrap.setAttribute("role","listitem");

  // actionsÔºàÈÄöÂ∏∏„É¢„Éº„Éâ„ÅÆ„Çπ„ÉØ„Ç§„ÉóÂâäÈô§Ôºâ
  const actions=document.createElement("div");
  actions.className="actions";
  const delBtn=document.createElement("button");
  delBtn.type="button";
  delBtn.textContent="ÂâäÈô§";
  delBtn.setAttribute("aria-label", `ÂâäÈô§: ${it.text}`);
  delBtn.addEventListener("click", ()=>removeOne(it.id));
  actions.appendChild(delBtn);
  wrap.appendChild(actions);

  // row
  const row=document.createElement("div");
  row.className="row";
  row._x = 0;
  row.style.transform="translateX(0)";
  row._justSwiped = false;

  // left (minus)
  const left=document.createElement("div");
  left.className="leftSlot";
  const minus=document.createElement("button");
  minus.className="del";
  minus.innerHTML='<span class="minus-bar" aria-hidden="true"></span>';
  minus.type="button";
  minus.style.display = state.editMode ? "inline-flex" : "none";
  minus.setAttribute("aria-label", `ÂâäÈô§„É°„Éã„É•„Éº: ${it.text}`);

  // Á∑®ÈõÜ„É¢„Éº„ÉâÔºö‚àí„Åß„ÄåÂâäÈô§„Éú„Çø„É≥Ë°®Á§∫„Äç„Éà„Ç∞„É´Ôºà„Åù„ÅÆÂæå„ÅÆÂâäÈô§„ÅØÂç≥ÂâäÈô§Ôºâ
  minus.addEventListener("click", ()=>{
    if(!state.editMode) return;

    if(state.openEditId && state.openEditId !== it.id){
      const prev = wrapEl(state.openEditId);
      if(prev) prev.classList.remove("show-actions");
      setRowX(state.openEditId, 0);
    }
    const willOpen = state.openEditId !== it.id;
    state.openEditId = willOpen ? it.id : null;
    wrap.classList.toggle("show-actions", willOpen);
    setRowX(it.id, willOpen ? -ACTION_W : 0);
  });

  left.appendChild(minus);
  row.appendChild(left);

  // checkbox
  const cb=document.createElement("input");
  cb.type="checkbox";
  cb.className="cb";
  cb.checked=!!it.done;
  cb.disabled=state.editMode;
  cb.setAttribute("aria-label", `ÂÆå‰∫ÜÂàá„ÇäÊõø„Åà: ${it.text}`);
  cb.addEventListener("change", ()=>toggleDone(it.id, cb.checked));
  row.appendChild(cb);

  // text
  const text=document.createElement("div");
  text.className="text" + (it.done ? " checked":"");
  text.textContent=it.text;
  text.setAttribute("role","button");
  text.setAttribute("tabindex","0");
  text.setAttribute("aria-label", `È†ÖÁõÆ: ${it.text}Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÆå‰∫ÜÂàáÊõøÔºâ`);
  text.addEventListener("click", ()=>{
    if(state.editMode) return;
    cb.checked = !cb.checked;
    toggleDone(it.id, cb.checked);
  });
  text.addEventListener("keydown", (e)=>{
    if(state.editMode) return;
    if(e.key==="Enter" || e.key===" "){
      e.preventDefault();
      cb.checked = !cb.checked;
      toggleDone(it.id, cb.checked);
    }
  });
  row.appendChild(text);

  // handle
  const right=document.createElement("div");
  right.className="rightSlot";
  const handle=document.createElement("div");
  handle.className="handle";
  handle.textContent="‚â°";
  handle.setAttribute("role","button");
  handle.setAttribute("tabindex","0");
  handle.setAttribute("aria-label","‰∏¶„ÅπÊõø„Åà„Éè„É≥„Éâ„É´ÔºàAlt+‚Üë/‚Üì„Åß„ÇÇÁßªÂãï„Åß„Åç„Åæ„ÅôÔºâ");

  handle.addEventListener("pointerdown", e=>{
    if(!state.editMode) return;
    e.preventDefault();
    e.stopPropagation();
    startDrag(e, wrap);
  });

  handle.addEventListener("keydown", (e)=>{
    if(!state.editMode) return;
    if(e.altKey && (e.key === "ArrowUp" || e.key === "ArrowDown")){
      e.preventDefault();
      const dir = (e.key === "ArrowUp") ? -1 : 1;
      const moved = moveItemById(it.id, dir);
      if(moved){
        announce(`ÁßªÂãï„Åó„Åæ„Åó„Åü: ${it.text}`);
        setTimeout(()=>{
          const w = wrapEl(it.id);
          w?.querySelector(".handle")?.focus?.();
        }, 0);
      }
    }
  });

  right.appendChild(handle);
  row.appendChild(right);

  // row clickÔºà„Çπ„ÉØ„Ç§„ÉóÁõ¥ÂæåclickÊäëÊ≠¢Ôºâ
  row.addEventListener("click",(e)=>{
    if(row._justSwiped){
      row._justSwiped = false;
      return;
    }

    if(state.editMode){
      if(e.target.closest(".del")) return;
      if(e.target.closest(".actions")) return;
      if(state.openEditId){
        const w = wrapEl(state.openEditId);
        if(w) w.classList.remove("show-actions");
        setRowX(state.openEditId, 0);
        state.openEditId = null;
      }
    }else{
      if(state.openId===it.id){
        setRowX(it.id, 0);
        state.openId=null;
      }
    }
  });

  attachSwipe(row, it.id);

  wrap.appendChild(row);
  return wrap;
}

/* =======================
   Swipe (normal mode)
======================= */
function attachSwipe(row,id){
  let startX=0, startY=0;
  let swiping=false;
  let active=false;
  let baseX=0;
  let pid=null;

  const isInteractive = (t) => !!t.closest("input,button,.handle,.del");

  row.addEventListener("pointerdown",(e)=>{
    if(state.editMode) return;
    if(isInteractive(e.target)) return;

    closeOpenIfDifferent(id);

    active = true;
    pid = e.pointerId;
    startX = e.clientX;
    startY = e.clientY;
    swiping = false;

    baseX = (state.openId===id) ? -ACTION_W : 0;
    row.style.transition="none";
    row._x = baseX;

    try{ row.setPointerCapture(pid); }catch{}
  }, {passive:true});

  row.addEventListener("pointermove",(e)=>{
    if(state.editMode || !active) return;

    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    if(!swiping){
      if(Math.abs(dx) < 7) return;
      if(Math.abs(dx) <= Math.abs(dy) * 0.85) return;
      swiping = true;
    }

    e.preventDefault();

    let x = baseX + dx;
    x = Math.min(0, Math.max(-ACTION_W, x));
    row._x = x;
    row.style.transform = `translateX(${x}px)`;
  }, {passive:false});

  const end = ()=>{
    if(state.editMode || !active) return;

    if(!swiping){
      if(state.openId===id){
        row.style.transition="transform .22s var(--spring)";
        setRowX(id, 0);
        state.openId=null;
      }
      active=false;
      return;
    }

    row.style.transition="transform .22s var(--spring)";
    const x = row._x || 0;
    const willOpen = (x <= -ACTION_W/2);
    setRowX(id, willOpen ? -ACTION_W : 0);
    state.openId = willOpen ? id : null;

    row._justSwiped = true;
    setTimeout(()=>{ row._justSwiped = false; }, 0);

    active=false;
  };

  row.addEventListener("pointerup", end, {passive:true});
  row.addEventListener("pointercancel", end, {passive:true});
}

/* =======================
   Drag reorderÔºàplaceholder + rAFÔºâ
======================= */
function startDrag(e,wrap){
  if(state.openEditId){
    const w = wrapEl(state.openEditId);
    if(w) w.classList.remove("show-actions");
    setRowX(state.openEditId, 0);
    state.openEditId = null;
  }

  state.dragWrap = wrap;
  const row = wrap.querySelector(".row");
  row.classList.add("dragging");

  const h = wrap.getBoundingClientRect().height;
  state.placeholder = document.createElement("div");
  state.placeholder.className = "placeholder";
  state.placeholder.style.height = h + "px";

  const dragRect = wrap.getBoundingClientRect();
  state.dragOffsetY = e.clientY - dragRect.top;
  state.dragPointerId = e.pointerId;

  dom.list.insertBefore(state.placeholder, wrap.nextSibling);

  const listRect = dom.list.getBoundingClientRect();
  wrap.style.width = listRect.width + "px";
  wrap.classList.add("floating");
  wrap.style.transform = `translate3d(${listRect.left}px, ${dragRect.top}px, 0)`;

  try{ wrap.setPointerCapture(state.dragPointerId); }catch{}

  state.latestClientY = e.clientY;

  const applyMove = ()=>{
    state.rafId = null;
    if(!state.dragWrap) return;

    const listRect2 = dom.list.getBoundingClientRect();
    const y = state.latestClientY - state.dragOffsetY;

    state.dragWrap.style.transform = `translate3d(${listRect2.left}px, ${y}px, 0)`;

    const after = getAfterForPlaceholder(state.latestClientY);
    if(after === null){
      dom.list.appendChild(state.placeholder);
    }else{
      dom.list.insertBefore(state.placeholder, after);
    }

    autoScrollWithinList(state.latestClientY);
  };

  const move = (ev)=>{
    if(!state.dragWrap) return;
    ev.preventDefault();

    state.latestClientY = ev.clientY;

    if(state.rafId) return;
    state.rafId = requestAnimationFrame(applyMove);
  };

  const up = ()=>{
    if(!state.dragWrap) return;

    if(state.rafId){
      cancelAnimationFrame(state.rafId);
      state.rafId = null;
    }

    dom.list.insertBefore(state.dragWrap, state.placeholder);
    state.placeholder.remove();
    state.placeholder = null;

    state.dragWrap.classList.remove("floating");
    state.dragWrap.style.transform = "";
    state.dragWrap.style.width = "";

    row.classList.remove("dragging");
    const movedId = state.dragWrap.dataset.id;

    state.dragWrap = null;
    state.dragPointerId = null;

    persistOrder();

    const movedItem = getItem(movedId);
    if(movedItem) announce(`‰∏¶„ÅπÊõø„Åà„Åæ„Åó„Åü: ${movedItem.text}`);

    window.removeEventListener("pointermove", move, true);
    window.removeEventListener("pointerup", up, true);
    window.removeEventListener("pointercancel", up, true);
  };

  window.addEventListener("pointermove", move, {passive:false, capture:true});
  window.addEventListener("pointerup", up, {passive:false, capture:true});
  window.addEventListener("pointercancel", up, {passive:false, capture:true});
}

function getAfterForPlaceholder(y){
  const els = [...dom.list.querySelectorAll(".swipe-wrap")]
    .filter(w => w !== state.dragWrap);

  let closest = {offset: -Infinity, el: null};
  for(const w of els){
    const box = w.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset){
      closest = {offset, el: w};
    }
  }
  return closest.el;
}

function autoScrollWithinList(pointerY){
  const rect = dom.list.getBoundingClientRect();
  const edge = 36;
  const speed = 10;

  if(pointerY < rect.top + edge){
    dom.list.scrollTop -= speed;
  }else if(pointerY > rect.bottom - edge){
    dom.list.scrollTop += speed;
  }
}

function persistOrder(){
  const ordered=[...dom.list.querySelectorAll(".swipe-wrap")].map(w=>w.dataset.id);
  const map=new Map(state.items.map(i=>[i.id,i]));
  state.items = ordered.map(id=>map.get(id)).filter(Boolean);
  STORAGE.save();
}

/* =======================
   Top actions
======================= */
dom.editBtn.addEventListener("click", ()=>{
  closeAllSwipe();
  state.editMode=!state.editMode;
  dom.app.classList.toggle("edit",state.editMode);
  dom.editBtn.textContent = state.editMode ? "‚úì" : "Á∑®ÈõÜ";
  dom.editBtn.setAttribute("aria-label", state.editMode ? "Á∑®ÈõÜ„É¢„Éº„ÉâËß£Èô§" : "Á∑®ÈõÜ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà");
  announce(state.editMode ? "Á∑®ÈõÜ„É¢„Éº„Éâ„Å´„Åó„Åæ„Åó„Åü" : "Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü");

  dom.list.querySelectorAll(".swipe-wrap").forEach(w=>{
    const row = w.querySelector(".row");
    const cb = w.querySelector(".cb");
    const minus = w.querySelector(".del");

    cb.disabled = state.editMode;
    cb.style.pointerEvents = state.editMode ? "none" : "auto";
    cb.style.opacity = state.editMode ? ".25" : "1";
    minus.style.display = state.editMode ? "inline-flex" : "none";

    w.classList.remove("show-actions");
    row.style.transition = "transform .22s var(--spring)";
    setRowX(w.dataset.id, 0);
    row._justSwiped = false;
  });

  state.openId = null;
  state.openEditId = null;
});

dom.trashBtn.addEventListener("click", async ()=>{
  const ok = await MODAL.showConfirm({
    title:"ÂÖ®ÂâäÈô§",
    message:"„É™„Çπ„Éà„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ",
    okText:"ÂâäÈô§",
    cancelText:"„Ç≠„É£„É≥„Çª„É´",
    danger:true
  });
  if(!ok) return;

  state.items=[];
  STORAGE.save();
  dom.list.innerHTML="";
  state.openId=null;
  state.openEditId=null;
  layoutCardHeight();
  announce("„É™„Çπ„Éà„ÇíÂÖ®ÂâäÈô§„Åó„Åæ„Åó„Åü");
});

dom.shareBtn.addEventListener("click", async ()=>{
  const text=state.items.map(i=>`${i.done?"‚òë":"‚òê"} ${i.text}`).join("\n");
  try{
    if(navigator.share){
      await navigator.share({title:"Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà",text});
      announce("ÂÖ±Êúâ„Åó„Åæ„Åó„Åü");
    }else{
      await navigator.clipboard.writeText(text);
      alert("„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
      announce("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
    }
  }catch{}
});

dom.plusBtn.addEventListener("click", ()=>{
  if(!dom.inputWrap.classList.contains("show")){
    dom.inputWrap.classList.add("show");
    dom.newText.focus();
    layoutCardHeight();
  }else commitAdd();
});

dom.newText.addEventListener("keydown", e=>{
  if(e.key==="Enter") commitAdd();
  if(e.key==="Escape"){
    dom.inputWrap.classList.remove("show");
    dom.newText.value="";
    layoutCardHeight();
    announce("ÂÖ•Âäõ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü");
  }
});

function commitAdd(){
  const t=dom.newText.value.trim();
  if(!t) return;

  const it = {id:uid(), text:t, done:false};
  state.items.push(it);
  STORAGE.save();

  dom.newText.value="";
  dom.inputWrap.classList.add("show");
  dom.newText.focus();

  dom.list.appendChild(buildRow(it));
  layoutCardHeight();
  announce(`ËøΩÂä†„Åó„Åæ„Åó„Åü: ${it.text}`);
}

/* =======================
   Global close behavior
======================= */
document.addEventListener("pointerdown",(e)=>{
  if(e.target.closest(".swipe-wrap")) return;
  if(e.target.closest(".actions")) return;
  if(dom.modal.classList.contains("show")) return;
  closeAllSwipe();
},{capture:true});

/* =======================
   Init
======================= */
STORAGE.load();
renderAll();
layoutCardHeight();
</script>
</body>
</html>
